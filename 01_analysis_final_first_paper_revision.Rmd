---
title: "PHOSP-COVID report"
author: "PHOSP-COVID collaborative"
output:
  word_document:
    toc: no
    toc_depth: '3'
  html_document:
    code_folding: hide
    toc: yes
    toc_depth: 3
    toc_float: yes
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
if (knitr::is_html_output()){
  knitr::opts_chunk$set(echo = TRUE,
                        warning = FALSE,
                        message = FALSE)
} else {
  knitr::opts_chunk$set(echo = FALSE,
                        warning = FALSE,
                        message = FALSE)
}

library(finalfit)
library(knitr)
library(tidyverse)
library(rmarkdown)

summary_factorlist <- purrr::partial(finalfit::summary_factorlist, na_to_prop = FALSE)
source("geom_boxplot2.R")
```

```{r eval=FALSE, include=FALSE}
# Pull and prep
source("01_data_pull.R")
lastrun = Sys.time()
source("02_functions.R")
source("03_prep.R")
source("04_clustering.R")
```

```{r eval=FALSE, include=FALSE}
# For exploration 
library(readr) # loaded with tidyverse anyway
datadir = "/home/common/phosp/raw/"
timestamp = "2021-03-12_1624"
phosp   = read_rds(paste0(datadir, "phosp_", timestamp, ".rds"))
lastrun = Sys.time()
source("/home/eharrison/phosp_clean/02_functions.R")
source("/home/eharrison/phosp_clean/03_prep.R")
source("/home/eharrison/phosp_clean/05_kco.R")
save.image("full_image_010721.Rdata")
```

```{r}
load("full_image_010721.Rdata")
```


### Tier 2 cohort before 30 Nov 2020 with < 240 days follow-up

```{r}
# Filter at 240 days follow up. 
## It would have been more correct to use the date: crf3b_date_visit or psq_date
## But after discussion left as is. 

study_id_240 = phosp %>% 
  group_by(study_id) %>% 
  fill(crf1a_date_dis, crf3a_visit_date, .direction = "downup") %>% 
  select(study_id, crf1a_date_dis, crf3a_visit_date) %>% 
  distinct(study_id, .keep_all = TRUE) %>% 
  mutate(discharge2review = (crf3a_visit_date - crf1a_date_dis) %>% as.numeric()) %>% 
  filter(discharge2review <= 240 | is.na(discharge2review)) %>% 
  pull(study_id)
```


All analyses below are for tier 2 patients discharged on or before 30th Nov 2020 who have respiratory support data. 
Added: remove those with missing sex/gender. 

```{r}
keep = phosp_hosp %>% 
  filter(tier == 2) %>% 
  filter(study_id %in% study_id_before_end_nov) %>%
  filter(study_id %in% study_id_240) %>% 
  drop_na(crf1a_resp_support_4levels) %>% 
  filter(!is.na(crf1a_sex)) %>% 
  filter(study_id != "28-31") %>% # Temp remove as no 3 m data coming through
  pull(study_id)

phosp_hosp = phosp_hosp %>% 
  filter(study_id %in% keep)

phosp_3m = phosp_3m %>% 
  left_join(phosp_hosp %>% select(study_id, crf1a_resp_support_4levels)) %>% 
  filter(study_id %in% keep)

phosp = phosp %>% 
  filter(study_id %in% keep)

phosp_wt = phosp_wt %>% 
  filter(study_id %in% keep)
```

```{r}
# Any joins can be temporarily done here, then moved to cleaning. 
phosp_hosp = phosp_hosp %>% 
  left_join(phosp %>% 
              filter(redcap_event_name == "3 Months (1st Research Visit)") %>% 
              select(study_id, crf3a_bmi, crf3a_bmi_2levels, crf3a_bmi_5levels) %>% 
              drop_na(crf3a_bmi)
  )
```

```{r}
# Temp variable changes / collapses
## Pull psq_recovered from 6 week data if missing at 3 months
phosp_hosp = phosp_hosp %>% 
  left_join(phosp_3m %>% select(study_id, psq_recovered, eq5d5l_summary_delta, discharge_to_3m_review)) %>%
  left_join(phosp_6w %>% select(study_id, 
                                psq_recovered_6w = psq_recovered,
                                eq5d5l_summary_delta_6w = eq5d5l_summary_delta)) %>% 
  mutate(
    psq_recovered = case_when(
      is.na(psq_recovered) & !is.na(psq_recovered_6w) ~ psq_recovered_6w,
      TRUE ~ psq_recovered
    ) %>% fct_recode("No" = "Not sure") %>% 
      fct_relevel("No"),
    
    eq5d5l_summary_delta = case_when(
      is.na(eq5d5l_summary_delta) & !is.na(eq5d5l_summary_delta_6w) ~ eq5d5l_summary_delta_6w,
      TRUE ~ eq5d5l_summary_delta)
  ) %>% 
  ff_relabel_df(phosp_hosp)

phosp_3m = phosp_3m %>% 
  select(-psq_recovered, -eq5d5l_summary_delta) %>% 
  left_join(phosp_hosp %>% select(study_id, psq_recovered, eq5d5l_summary_delta)) %>% 
  ff_relabel_df(phosp_3m)
```

```{r}
# Smoking
phosp_smoking = phosp_3m %>% 
  select(study_id, patient_sq_n) %>% 
  left_join(phosp_6w %>% select(study_id, patient_sq_n_6w = patient_sq_n)) %>% 
  mutate(patient_sq_n= case_when(
    is.na(patient_sq_n) & !is.na(patient_sq_n_6w) ~ patient_sq_n_6w,
    TRUE ~ patient_sq_n
  ) %>% 
    ff_label("Smoking")
  ) %>% 
  select(study_id, patient_sq_n)

phosp_hosp = phosp_hosp %>% 
  left_join(phosp_smoking) %>% 
    mutate(patient_sq_n = ff_label(patient_sq_n, "Smoking"))
```


## Table 1: Comparison of participant demographics, pre-existing co-morbidities, and admission characteristics stratified by severity of acute illness.

NOTE: discharge to review updated here. Other variables should be the same. 

```{r}
explanatory = c("swab_pcr_result", 
                "discharge_to_3m_review",
                "age_admission", 
                "crf1a_sex", 
                "crf1b_eth_5levels", 
                "imd_quintile",
                "crf3a_bmi",
                "crf3a_bmi_2levels",
                "crf3a_bmi_5levels", 
                
                "patient_sq_n",
                
                # Comorbidities
                "no_comorbid",
                "no_comorbid_3levels",
                "crf1a_com_card", "crf1a_com_neupsy",
                "crf1a_com_res", "crf1a_com_rheu",
                "crf1a_com_gast", "crf1a_com_mer", 
                "crf1a_com_mh", "crf1a_com_diab",
                "crf1a_com_id",
                
                "crf1a_admission_duration",
                
                "crf1a_treat_ss", "crf1a_treat_at", "crf1a_treat_tdac")

dependent = "crf1a_resp_support_4levels"
phosp_hosp %>% 
  summary_factorlist(dependent,  explanatory, 
                     na_include = TRUE, na_include_dependent = TRUE, 
                     add_col_totals = TRUE, cont_nonpara = c(2, 4:20), p = TRUE, digits = c(1, 1, 4, 1),
                     total_col = TRUE) %>% 
  ff_remove_ref() %>% 
  ff_column_totals(phosp_hosp, dependent) %>% 
  ff_row_totals(phosp_hosp, dependent, explanatory, missing_column = FALSE) %>% 
  mytable()
```

```{r}
phosp_hosp %>%
  group_by(crf1a_resp_support_4levels) %>% 
  filter(is.na(age_admission)) %>% 
  count(age_admission)

phosp_hosp %>%
  group_by(crf1a_resp_support_4levels) %>% 
  filter(is.na(crf1a_admission_duration)) %>% 
  count(age_admission)
```


## Table 2: Proportion unchanged, worse or better in terms of overall visual analogue score and EQ5D prior to hospitalisation and at follow-up stratified by severity of acute illness.


NOTE: psq_recovered numbers updated here. 


```{r}
dependent = "crf1a_resp_support_4levels"
explanatory_differences = c("psq_recovered",
                            "eq5d5l_summary_pre",
                            "eq5d5l_summary",
                            "eq5d5l_summary_delta",
                            "eq5d5l_summary_delta_change",
                            # Pull delta_change names
                            phosp %>% 
                              select(matches("eq5d5l_q.*_delta_change")
                              ) %>% 
                              names(),
                            "eq5d5l_utility_index_pre",
                            "eq5d5l_utility_index",
                            "eq5d5l_utility_index_delta",
                            
                            "patient_sq_l_t_disability",
                            "patient_sq_l_t__new_disability")

phosp_3m %>%
  left_join(phosp_hosp %>% select(study_id, crf1a_resp_support_4levels)) %>% 
  summary_factorlist(dependent,  explanatory_differences,
                     na_include = TRUE, na_include_dependent = TRUE, 
                     add_col_totals = TRUE, digits = c(2, 2, 4, 1),
                     total_col = TRUE, p = TRUE) %>% 
  mytable()
```

## Table 3: Health-related quality of life, physiological and functional status at follow-up stratified for severity of acute illness. 

```{r}
phosp_wt_table = phosp_wt %>% 
  filter(wt_type == "Incremental shuttle walk test (ISWT) Modified 15 level") %>% 
  filter(wt_visit == "3 months") %>% 
  drop_na(wt_distance) %>% 
  mutate(wt_iswt_predicted_perc = replace_na(wt_iswt_predicted_perc, 0)) %>% # to deal with max returning inf
  group_by(study_id) %>%  # More than one test per patient
  mutate(value_max = if_else(row_number() == which.max(wt_iswt_predicted_perc), TRUE, FALSE)) %>% 
  filter(value_max) %>% 
  select(study_id, wt_distance, wt_iswt_predicted_perc) %>% 
  as.data.frame() %>% 
  ff_relabel_df(phosp_wt)

phosp_pft_table = phosp %>% 
  filter(redcap_event_name== "3 Months (1st Research Visit)") %>% 
  filter(redcap_repeat_instrument == "Pulmonary Functional Tests") %>% 
  filter(pft_spm_done == "Yes") %>% 
  select(study_id, starts_with("pft_")) %>% 
  drop_na(pft_fev1) %>% 
  group_by(study_id) %>% 
  mutate(value_max = if_else(row_number() == which.max(pft_fev1), TRUE, FALSE)) %>% 
  filter(value_max) %>% 
  select("pft_fev1_perc_pred",
         "pft_fev1",
         "pft_fev1_perc_pred_80",
         "pft_fvc_perc_pred",
         "pft_fvc",
         "pft_fvc_perc_pred_80",
         "pft_fev1_fvc", 
         "pft_fev1_fvc_70") %>% 
  as.data.frame() %>% 
  ff_relabel_df(phosp)

# Do kco and tlco extraction and percentage normal separately. 
phosp_kco_table = phosp %>% 
  filter(redcap_event_name== "3 Months (1st Research Visit)") %>% 
  filter(redcap_repeat_instrument == "Pulmonary Functional Tests") %>% 
  filter(pft_spm_done == "Yes") %>% 
  select(study_id, pft_tlco, pft_kco) %>% 
  drop_na(pft_kco) %>% 
  left_join(phosp_kco %>% select(study_id, tlcoM_SI_pred, kcoM_SI_pred)) %>% 
  mutate(
    pft_tlco_pred = (100 * pft_tlco / tlcoM_SI_pred) %>% ff_label("TLCO % predicted"),
    pft_kco_pred = (100 * pft_kco / kcoM_SI_pred) %>% ff_label("KCO % predicted"),
    
    pft_tlco_pred_80 = case_when(
      pft_tlco_pred < 80 ~ "Yes",
      pft_tlco_pred >= 80 ~ "No",
    ) %>% 
      ff_label("TLCO predicted <80%"),
      
    pft_kco_pred_80 = case_when(
      pft_kco_pred < 80 ~ "Yes",
      pft_kco_pred >= 80 ~ "No",
    ) %>% 
      ff_label("KCO predicted <80%"),
    
  ) %>% 
  ff_relabel_df(phosp)

phosp_pft_table = phosp_pft_table %>% 
  left_join(phosp_kco_table)
```


```{r}
phosp_bloods_table = phosp %>% 
  filter(redcap_event_name== "3 Months (1st Research Visit)") %>% 
  filter(redcap_repeat_instrument == "Laboratory Results Collection Log - Routine blood tests") %>% 
  group_by(study_id) %>% 
  summarise(
    # This needs to summarise over multiple blood tests per visit. 
    # Take max values and yes over no. 
    # Convoluted by necessity. 
    # note case_when doesn't currently work with any. Known issue Feb 21
    bnp_result = ifelse(all(is.na(bnp_result)), NA, max(bnp_result, na.rm = TRUE)),
    pnbnp_result = ifelse(all(is.na(pnbnp_result)), NA, max(pnbnp_result, na.rm = TRUE)),
    bnp_summary = ifelse(any(bnp_summary == "Yes", na.rm = TRUE), "Yes", 
                          ifelse(any(bnp_summary == "No", na.rm = TRUE), "No", 
                                 NA)),
    
    hba1c_result = ifelse(all(is.na(hba1c_result)), NA, max(hba1c_result, na.rm = TRUE)),
    hba1c_summary = ifelse(any(hba1c_summary  == "Yes", na.rm = TRUE), "Yes", 
                          ifelse(any(hba1c_summary  == "No", na.rm = TRUE), "No", 
                                 NA)),
    
    egfr_result = ifelse(all(is.na(egfr_result)), NA, max(egfr_result, na.rm = TRUE)),
    egfr_summary = ifelse(any(egfr_summary == "Yes", na.rm = TRUE), "Yes", 
                          ifelse(any(egfr_summary == "No", na.rm = TRUE), "No", 
                                 NA)),
    
    ddi_result = ifelse(all(is.na(ddi_result)), NA, max(ddi_result, na.rm = TRUE)),
    ddi_summary = ifelse(any(ddi_summary == "Yes", na.rm = TRUE), "Yes", 
                          ifelse(any(ddi_summary == "No", na.rm = TRUE), "No", 
                                 NA)),
    
    crp_result = ifelse(all(is.na(crp_result)), NA, max(crp_result , na.rm = TRUE)),
    crp_summary = ifelse(any(crp_summary  == "Yes", na.rm = TRUE), "Yes", 
                          ifelse(any(crp_summary == "No", na.rm = TRUE), "No", 
                                 NA)),
  ) %>% 
  ff_relabel_df(phosp)

# Added 28/07/2021
## CRP>5

phosp_bloods_table = phosp_bloods_table %>% 
  mutate(
    crp_summary5 = case_when(
      crp_result > 5 ~ "Yes",
      crp_result <= 5 ~ "No"
    ) %>% 
      ff_label("CRP (>5 mg/L)")
  )

explanatory_hrqol = c(
  "symptom_any",
  "symptom_count",
  "gad7_summary_2levels",
  "phq9_summary_2levels",
  "pcl5_summary_2levels",
  "dyspnoea12_summary",
  #"facit_v4_summary",
  "facit_item_total",
  "bpi_severity_summary",
  "bpi_interference_summary",
  "sppb_score",
  "sppb_score_summary",
  "wt_distance",
  "wt_iswt_predicted_perc",
  "rcf_score_summary",
  "mocal_total_summary",
  "mocal_total_corrected_summary",  
  "pft_fev1_perc_pred", 
  "pft_fev1_perc_pred_80",
  "pft_fev1_fvc_70",
  "pft_fvc_perc_pred_80",
  "pft_tlco",
  "pft_tlco_pred",
  "pft_tlco_pred_80",
  "pft_kco",           
  "pft_kco_pred",
  "pft_kco_pred_80",
  "bnp_summary",
  "hba1c_summary",
  "egfr_summary",
  "ddi_result",
  "ddi_summary",
  "crp_summary5",
  "crp_summary"
)
phosp_3m %>%
  left_join(phosp_wt_table) %>% 
  left_join(phosp_pft_table) %>% 
  left_join(phosp_bloods_table) %>% 
  left_join(phosp_hosp %>% select(study_id, crf1a_resp_support_4levels)) %>% 
  select(dependent, explanatory_hrqol) %T>% 
  {data_in <<- .} %>% 
  summary_factorlist(dependent,  explanatory_hrqol,
                     na_include = TRUE, na_include_dependent = TRUE, 
                     total_col = TRUE, cont_nonpara = c(2),
                     add_col_totals = TRUE, add_row_totals = TRUE, include_row_missing_col = FALSE,
                     p = TRUE, digits = c(1, 1, 4, 1)) %>%
  mytable()
```

## Table 4: Occupation status prior to hospitalisation and at follow-up stratified by acute illness

```{r}
explanatory_occupation = c(
  # "crf1b_healthcare_worker", "crf1b_caring",
  "social_status_before", #  "social_status_after", 
  "working_status_change", "working_less", 
  "no_longer_working", "health_reasons",
  "employer_reasons", "other_reasons"
  
  # "patient_sq_q", "patient_sq_q_today", "patient_sq_q_change",
  # "patient_sq_p_smoking", "patient_sq_p_drinking",
  # "patient_sq_p_eating", "patient_sq_p_activity"
)

phosp_3m %>%
  left_join(phosp_hosp %>% select(study_id, crf1a_resp_support_4levels, crf1b_healthcare_worker, crf1b_caring)) %>% 
  summary_factorlist(dependent,  explanatory_occupation,
                     na_include = TRUE, na_include_dependent = TRUE,
                     total_col = TRUE,
                     add_col_totals = TRUE, add_row_totals = TRUE, include_row_missing_col = FALSE,
                     p = TRUE, digits = c(1, 1, 4, 1)) %>% 
  mytable()
```


## Table 5: Characteristics associated with recovery versus persistent symptoms and disability 

```{r}
dependent = "psq_recovered"
phosp_hosp %>% 
  summary_factorlist(dependent,  explanatory, 
                     na_include = TRUE, na_include_dependent = TRUE, 
                     add_col_totals = TRUE, cont_nonpara = c(2, 4:20),
                     total_col = TRUE) %>% 
  ff_remove_ref() %>% 
  ff_column_totals(phosp_hosp, dependent) %>% 
  dependent_label(phosp_hosp, dependent) %>% 
  mytable()
```

```{r}
## Multiple imputation
library(mice)
library(finalfit)
library(purrr)
```


```{r eval=FALSE, include=FALSE}
# Run mice
set.seed(1)
explanatory = c("age_admission", 
                "crf1a_sex", 
                "crf1b_eth_5levels", 
                "imd_quintile",
                "crf3a_bmi",
                
                "crf1a_resp_support_4levels",
                
                # Comorbidities - # None of these are imputed as missing considered absent
                "no_comorbid",
                "no_comorbid_3levels",
                "crf1a_com_card", "crf1a_com_neupsy",
                "crf1a_com_res", "crf1a_com_rheu",
                "crf1a_com_gast", "crf1a_com_mer", 
                "crf1a_com_mh", "crf1a_com_diab",
                "crf1a_com_id",
                
                "crf1a_admission_duration",
                
                "crf1a_treat_ss", "crf1a_treat_at", "crf1a_treat_tdac",
                "psq_recovered",
                
                "study_id",
                "redcap_data_access_group",
                
                "discharge_to_3m_review")


# Choose not to impute missing values
# for explanatory variable of interest and
# outcome variable. 
# But include in algorithm for imputation.
predM = phosp_hosp %>% 
  select(explanatory) %>% 
  missing_predictorMatrix(
    drop_from_imputed = c("study_id"), 
    drop_from_imputer = c("study_id", "redcap_data_access_group", "discharge_to_3m_review"))

# This is needed to drop from imputed!
m0 = mice(phosp_hosp %>% 
  select(explanatory), maxit=0)
m0$method[c("study_id")] = ""

phosp_hosp_imputed = phosp_hosp %>% 
  select(explanatory) %>% 
  mice(m = 10, maxit = 10, predictorMatrix = predM, method = m0$method)

plot(phosp_hosp_imputed)
summary(phosp_hosp_imputed)

saveRDS(phosp_hosp_imputed, file = "phosp_hosp_imputed_010721.rds")
```

```{r}
# Load mice sets
phosp_hosp_imputed = readRDS("phosp_hosp_imputed_010721.rds")
# phosp_hosp_imputed = readRDS("phosp_hosp_imputed_290621.rds")
# phosp_hosp_imputed = readRDS("phosp_hosp_imputed_210321.rds")
```


## Table 6A: Original: Multivariable logistic regression (with BMI 2 levels WIHOUT discharge_to_review)
### REVISED

```{r}
## Decide about metrcs later.
dependent = "psq_recovered"
explanatory = c("age_admission_factor", "crf1a_sex", "crf1b_eth_5levels", "imd_quintile", "no_comorbid_3levels", "crf3a_bmi_2levels", "crf1a_resp_support_4levels", "crf1a_treat_ss", "crf1a_treat_at", "crf1a_treat_tdac")
explanatory_multi = c("age_admission", "crf1a_sex", "crf1b_eth_5levels", "imd_quintile", "no_comorbid_3levels")

fit_cc = phosp_hosp %>% 
  finalfit(dependent, explanatory, keep_fit_id = TRUE)

fit_multi_imputed_pool = phosp_hosp_imputed %>% 
  mice::complete("all") %>%
  # Probably temp. Add age_admission_factor to imputed datasets
  purrr::map(~ mutate(., 
                      age_admission_factor = case_when(
                        age_admission < 30 ~ "<30",
                        age_admission < 40 ~ "30-39",
                        age_admission < 50 ~ "40-49",
                        age_admission < 60 ~ "50-59",
                        age_admission < 70 ~ "60-69",
                        age_admission < 80 ~ "70-79",
                        is.na(age_admission) ~ NA_character_,
                        TRUE ~ "80+"
                      ) %>% 
                        fct_relevel("50-59"),
                      
                      crf3a_bmi_2levels = case_when(
                        crf3a_bmi < 30 ~ "BMI < 30 kg/m^2",
                        is.na(crf3a_bmi) ~ NA_character_,
                        TRUE ~ "BMI 30+ kg/m^2"
                      ) %>% 
                        factor() %>% 
                        fct_relevel("BMI < 30 kg/m^2", "BMI 30+ kg/m^2") %>% 
                        ff_label("BMI (2 levels)")
  )
  ) %>% 
  purrr::map(~ glmmulti(.x, dependent, explanatory)) %>%
  as.mira() %>% 
  pool()


# Multilevel
library(broom.mixed)
fit_mixed_imputed_pool = phosp_hosp_imputed %>% 
  mice::complete("all") %>%
  # Probably temp. Add age_admission_factor to imputed datasets
  purrr::map(~ mutate(., 
               age_admission_factor = case_when(
                 age_admission < 30 ~ "<30",
                 age_admission < 40 ~ "30-39",
                 age_admission < 50 ~ "40-49",
                 age_admission < 60 ~ "50-59",
                 age_admission < 70 ~ "60-69",
                 age_admission < 80 ~ "70-79",
                 is.na(age_admission) ~ NA_character_,
                 TRUE ~ "80+"
               ) %>% 
                 fct_relevel("50-59"),
               
               crf3a_bmi_2levels = case_when(
                 crf3a_bmi < 30 ~ "BMI < 30 kg/m^2",
                 is.na(crf3a_bmi) ~ NA_character_,
                 TRUE ~ "BMI 30+ kg/m^2"
               ) %>% 
                 factor() %>% 
                 fct_relevel("BMI < 30 kg/m^2", "BMI 30+ kg/m^2") %>% 
                 ff_label("BMI (2 levels)"))
  ) %>% 
  purrr::map(~ glmmixed(.x, dependent, explanatory, random_effect = "redcap_data_access_group")) %>%
  as.mira() %>% 
  pool()

fit_multi_imputed = fit_multi_imputed_pool%>% 
  fit2df(estimate_name = "OR (multivariable imputation)", exp = TRUE)

fit_mixed_imputed = fit_mixed_imputed_pool%>% 
  fit2df(estimate_name = "OR (multilevel imputation)", exp = TRUE)
  
fit_cc %>% 
  # ff_merge(fit_uni_imputed) %>% 
  ff_merge(fit_multi_imputed) %>% 
  ff_merge(fit_mixed_imputed, last_merge = TRUE) %>% 
  # dplyr::relocate(1, 2, 3, 4, 5, 7, 6, 8) %>% 
  mytable()
```

## Figure: Multivariable logistic regression (multiple imputation) (with BMI 2 level WIHHOUT discharge_to_review) 

```{r fig.height=7, fig.width=12}
dependent = "psq_recovered"
explanatory = c("age_admission_factor", "crf1a_sex", "crf1b_eth_5levels", "imd_quintile", "no_comorbid_3levels", "crf3a_bmi_2levels", "crf1a_resp_support_4levels", "crf1a_treat_ss", "crf1a_treat_at", "crf1a_treat_tdac")

fit = phosp_hosp %>%
  or_plot(dependent, explanatory, column_space = c(-0.5, 0.15, 0.5), table_text_size = 4, 
          glmfit = fit_mixed_imputed_pool,
          dependent_label = "", suffix = "",
          breaks = c(0.2, 0.5, 1, 2, 5, 10, 30), )
# PDF 10 x 9
```


## New figure without abx and anticoag: Multivariable logistic regression (multiple imputation) (with BMI 2 level WIHHOUT discharge_to_review) 

```{r fig.height=7, fig.width=12}
dependent = "psq_recovered"
explanatory = c("age_admission_factor", "crf1a_sex", "crf1b_eth_5levels", "imd_quintile", "no_comorbid_3levels", "crf3a_bmi_2levels", "crf1a_resp_support_4levels", "crf1a_treat_ss")

fit = phosp_hosp %>%
  or_plot(dependent, explanatory, column_space = c(-0.5, 0.15, 0.5), table_text_size = 4, 
          glmfit = fit_mixed_imputed_pool,
          dependent_label = "", suffix = "",
          breaks = c(0.2, 0.5, 1, 2, 5, 10, 30), )
# PDF 10 x 9
```




## Table 6B: Multivariable logistic regression (with BMI 2 levels AND discharge_to_review)
### REVISED

```{r}
## Decide about metrcs later.
dependent = "psq_recovered"
explanatory = c("age_admission_factor", "crf1a_sex", "crf1b_eth_5levels", "imd_quintile", "no_comorbid_3levels", "crf3a_bmi_2levels", "crf1a_resp_support_4levels", "crf1a_treat_ss", "crf1a_treat_at", "crf1a_treat_tdac", "discharge_to_3m_review")
explanatory_multi = c("age_admission", "crf1a_sex", "crf1b_eth_5levels", "imd_quintile", "no_comorbid_3levels")

fit_cc = phosp_hosp %>% 
  finalfit(dependent, explanatory, keep_fit_id = TRUE)

fit_multi_imputed_pool = phosp_hosp_imputed %>% 
  mice::complete("all") %>%
  # Probably temp. Add age_admission_factor to imputed datasets
  purrr::map(~ mutate(., 
                      age_admission_factor = case_when(
                        age_admission < 30 ~ "<30",
                        age_admission < 40 ~ "30-39",
                        age_admission < 50 ~ "40-49",
                        age_admission < 60 ~ "50-59",
                        age_admission < 70 ~ "60-69",
                        age_admission < 80 ~ "70-79",
                        is.na(age_admission) ~ NA_character_,
                        TRUE ~ "80+"
                      ) %>% 
                        fct_relevel("50-59"),
                      
                      crf3a_bmi_2levels = case_when(
                        crf3a_bmi < 30 ~ "BMI < 30 kg/m^2",
                        is.na(crf3a_bmi) ~ NA_character_,
                        TRUE ~ "BMI 30+ kg/m^2"
                      ) %>% 
                        factor() %>% 
                        fct_relevel("BMI < 30 kg/m^2", "BMI 30+ kg/m^2") %>% 
                        ff_label("BMI (2 levels)")
  )
  ) %>% 
  purrr::map(~ glmmulti(.x, dependent, explanatory)) %>%
  as.mira() %>% 
  pool()


# Multilevel
library(broom.mixed)
fit_mixed_imputed_pool = phosp_hosp_imputed %>% 
  mice::complete("all") %>%
  # Probably temp. Add age_admission_factor to imputed datasets
  purrr::map(~ mutate(., 
               age_admission_factor = case_when(
                 age_admission < 30 ~ "<30",
                 age_admission < 40 ~ "30-39",
                 age_admission < 50 ~ "40-49",
                 age_admission < 60 ~ "50-59",
                 age_admission < 70 ~ "60-69",
                 age_admission < 80 ~ "70-79",
                 is.na(age_admission) ~ NA_character_,
                 TRUE ~ "80+"
               ) %>% 
                 fct_relevel("50-59"),
               
               crf3a_bmi_2levels = case_when(
                 crf3a_bmi < 30 ~ "BMI < 30 kg/m^2",
                 is.na(crf3a_bmi) ~ NA_character_,
                 TRUE ~ "BMI 30+ kg/m^2"
               ) %>% 
                 factor() %>% 
                 fct_relevel("BMI < 30 kg/m^2", "BMI 30+ kg/m^2") %>% 
                 ff_label("BMI (2 levels)"))
  ) %>% 
  purrr::map(~ glmmixed(.x, dependent, explanatory, random_effect = "redcap_data_access_group")) %>%
  as.mira() %>% 
  pool()

fit_multi_imputed = fit_multi_imputed_pool%>% 
  fit2df(estimate_name = "OR (multivariable imputation)", exp = TRUE)

fit_mixed_imputed = fit_mixed_imputed_pool%>% 
  fit2df(estimate_name = "OR (multilevel imputation)", exp = TRUE)
  
fit_cc %>% 
  # ff_merge(fit_uni_imputed) %>% 
  ff_merge(fit_multi_imputed) %>% 
  ff_merge(fit_mixed_imputed, last_merge = TRUE) %>% 
  # dplyr::relocate(1, 2, 3, 4, 5, 7, 6, 8) %>% 
  mytable()
```


## Figure: Multivariable logistic regression (multiple imputation) (with BMI 2 level) 

```{r fig.height=7, fig.width=12}
dependent = "psq_recovered"
explanatory = c("age_admission_factor", "crf1a_sex", "crf1b_eth_5levels", "imd_quintile", "no_comorbid_3levels", "crf3a_bmi_2levels", "crf1a_resp_support_4levels", "crf1a_treat_ss", "crf1a_treat_at", "crf1a_treat_tdac", "discharge_to_3m_review")

fit = phosp_hosp %>%
  or_plot(dependent, explanatory, column_space = c(-0.5, 0.15, 0.5), table_text_size = 4, 
          glmfit = fit_mixed_imputed_pool,
          dependent_label = "", suffix = "",
          breaks = c(0.2, 0.5, 1, 2, 5, 10, 30), )
# PDF 10 x 9
```


## New figure: Multivariable logistic regression (multiple imputation) (with BMI 2 level) 

```{r fig.height=7, fig.width=12}
dependent = "psq_recovered"
explanatory = c("age_admission_factor", "crf1a_sex", "crf1b_eth_5levels", "imd_quintile", "no_comorbid_3levels", "crf3a_bmi_2levels", "crf1a_resp_support_4levels", "crf1a_treat_ss", "discharge_to_3m_review")

fit = phosp_hosp %>%
  or_plot(dependent, explanatory, column_space = c(-0.5, 0.15, 0.5), table_text_size = 4, 
          glmfit = fit_mixed_imputed_pool,
          dependent_label = "", suffix = "",
          breaks = c(0.2, 0.5, 1, 2, 5, 10, 30), )
# PDF 10 x 9
```



# Models with out imputing outcome (for information, suggest not using)


```{r eval=FALSE, include=FALSE}
# Run mice
set.seed(1)
explanatory = c("age_admission", 
                "crf1a_sex", 
                "crf1b_eth_5levels", 
                "imd_quintile",
                "crf3a_bmi",
                
                "crf1a_resp_support_4levels",
                
                # Comorbidities - # None of these are imputed as missing considered absent
                "no_comorbid",
                "no_comorbid_3levels",
                "crf1a_com_card", "crf1a_com_neupsy",
                "crf1a_com_res", "crf1a_com_rheu",
                "crf1a_com_gast", "crf1a_com_mer", 
                "crf1a_com_mh", "crf1a_com_diab",
                "crf1a_com_id",
                
                "crf1a_admission_duration",
                
                "crf1a_treat_ss", "crf1a_treat_at", "crf1a_treat_tdac",
                "psq_recovered",
                
                "study_id",
                "redcap_data_access_group",
                
                "discharge_to_3m_review")


# Choose not to impute missing values
# for explanatory variable of interest and
# outcome variable. 
# But include in algorithm for imputation.
predM = phosp_hosp %>% 
  select(explanatory) %>% 
  missing_predictorMatrix(
    drop_from_imputed = c("study_id", "psq_recovered"), 
    drop_from_imputer = c("study_id", "redcap_data_access_group", "discharge_to_3m_review"))

# This is needed to drop from imputed!
m0 = mice(phosp_hosp %>% 
  select(explanatory), maxit=0)
m0$method[c("study_id", "psq_recovered")] = ""

phosp_hosp_imputed = phosp_hosp %>% 
  select(explanatory) %>% 
  mice(m = 10, maxit = 10, predictorMatrix = predM, method = m0$method)

plot(phosp_hosp_imputed)
summary(phosp_hosp_imputed)

saveRDS(phosp_hosp_imputed, file = "phosp_hosp_imputed_010721__2.rds")
```

```{r}
# Load mice sets
phosp_hosp_imputed = readRDS("phosp_hosp_imputed_010721__2.rds")
# phosp_hosp_imputed = readRDS("phosp_hosp_imputed_010721.rds")
# phosp_hosp_imputed = readRDS("phosp_hosp_imputed_290621.rds")
# phosp_hosp_imputed = readRDS("phosp_hosp_imputed_210321.rds")
```


## Table 6C: Multivariable logistic regression (with BMI 2 levels WIHOUT discharge_to_review, outcome not imputed)
### REVISED

```{r}
## Decide about metrcs later.
dependent = "psq_recovered"
explanatory = c("age_admission_factor", "crf1a_sex", "crf1b_eth_5levels", "imd_quintile", "no_comorbid_3levels", "crf3a_bmi_2levels", "crf1a_resp_support_4levels", "crf1a_treat_ss", "crf1a_treat_at", "crf1a_treat_tdac")
explanatory_multi = c("age_admission", "crf1a_sex", "crf1b_eth_5levels", "imd_quintile", "no_comorbid_3levels")

fit_cc = phosp_hosp %>% 
  finalfit(dependent, explanatory, keep_fit_id = TRUE)

fit_multi_imputed_pool = phosp_hosp_imputed %>% 
  mice::complete("all") %>%
  # Probably temp. Add age_admission_factor to imputed datasets
  purrr::map(~ mutate(., 
                      age_admission_factor = case_when(
                        age_admission < 30 ~ "<30",
                        age_admission < 40 ~ "30-39",
                        age_admission < 50 ~ "40-49",
                        age_admission < 60 ~ "50-59",
                        age_admission < 70 ~ "60-69",
                        age_admission < 80 ~ "70-79",
                        is.na(age_admission) ~ NA_character_,
                        TRUE ~ "80+"
                      ) %>% 
                        fct_relevel("50-59"),
                      
                      crf3a_bmi_2levels = case_when(
                        crf3a_bmi < 30 ~ "BMI < 30 kg/m^2",
                        is.na(crf3a_bmi) ~ NA_character_,
                        TRUE ~ "BMI 30+ kg/m^2"
                      ) %>% 
                        factor() %>% 
                        fct_relevel("BMI < 30 kg/m^2", "BMI 30+ kg/m^2") %>% 
                        ff_label("BMI (2 levels)")
  )
  ) %>% 
  purrr::map(~ glmmulti(.x, dependent, explanatory)) %>%
  as.mira() %>% 
  pool()


# Multilevel
library(broom.mixed)
fit_mixed_imputed_pool = phosp_hosp_imputed %>% 
  mice::complete("all") %>%
  # Probably temp. Add age_admission_factor to imputed datasets
  purrr::map(~ mutate(., 
               age_admission_factor = case_when(
                 age_admission < 30 ~ "<30",
                 age_admission < 40 ~ "30-39",
                 age_admission < 50 ~ "40-49",
                 age_admission < 60 ~ "50-59",
                 age_admission < 70 ~ "60-69",
                 age_admission < 80 ~ "70-79",
                 is.na(age_admission) ~ NA_character_,
                 TRUE ~ "80+"
               ) %>% 
                 fct_relevel("50-59"),
               
               crf3a_bmi_2levels = case_when(
                 crf3a_bmi < 30 ~ "BMI < 30 kg/m^2",
                 is.na(crf3a_bmi) ~ NA_character_,
                 TRUE ~ "BMI 30+ kg/m^2"
               ) %>% 
                 factor() %>% 
                 fct_relevel("BMI < 30 kg/m^2", "BMI 30+ kg/m^2") %>% 
                 ff_label("BMI (2 levels)"))
  ) %>% 
  purrr::map(~ glmmixed(.x, dependent, explanatory, random_effect = "redcap_data_access_group")) %>%
  as.mira() %>% 
  pool()

fit_multi_imputed = fit_multi_imputed_pool%>% 
  fit2df(estimate_name = "OR (multivariable imputation)", exp = TRUE)

fit_mixed_imputed = fit_mixed_imputed_pool%>% 
  fit2df(estimate_name = "OR (multilevel imputation)", exp = TRUE)
  
fit_cc %>% 
  # ff_merge(fit_uni_imputed) %>% 
  ff_merge(fit_multi_imputed) %>% 
  ff_merge(fit_mixed_imputed, last_merge = TRUE) %>% 
  # dplyr::relocate(1, 2, 3, 4, 5, 7, 6, 8) %>% 
  mytable()
```

## Figure: Multivariable logistic regression (multiple imputation) (with BMI 2 level WIHHOUT discharge_to_review) 

```{r fig.height=7, fig.width=12}
dependent = "psq_recovered"
explanatory = c("age_admission_factor", "crf1a_sex", "crf1b_eth_5levels", "imd_quintile", "no_comorbid_3levels", "crf3a_bmi_2levels", "crf1a_resp_support_4levels", "crf1a_treat_ss", "crf1a_treat_at", "crf1a_treat_tdac")

fit = phosp_hosp %>%
  or_plot(dependent, explanatory, column_space = c(-0.5, 0.15, 0.5), table_text_size = 4, 
          glmfit = fit_mixed_imputed_pool,
          dependent_label = "", suffix = "",
          breaks = c(0.2, 0.5, 1, 2, 5, 10, 30), )
# PDF 10 x 9
```

## New figure: Multivariable logistic regression (multiple imputation) (with BMI 2 level WIHHOUT discharge_to_review) 

```{r fig.height=7, fig.width=12}
dependent = "psq_recovered"
explanatory = c("age_admission_factor", "crf1a_sex", "crf1b_eth_5levels", "imd_quintile", "no_comorbid_3levels", "crf3a_bmi_2levels", "crf1a_resp_support_4levels", "crf1a_treat_ss")

fit = phosp_hosp %>%
  or_plot(dependent, explanatory, column_space = c(-0.5, 0.15, 0.5), table_text_size = 4, 
          glmfit = fit_mixed_imputed_pool,
          dependent_label = "", suffix = "",
          breaks = c(0.2, 0.5, 1, 2, 5, 10, 30), )
# PDF 10 x 9
```


## Table 6D: Multivariable logistic regression (with BMI 2 levels AND discharge_to_review, outcome not imputed)
### REVISED

```{r}
## Decide about metrcs later.
dependent = "psq_recovered"
explanatory = c("age_admission_factor", "crf1a_sex", "crf1b_eth_5levels", "imd_quintile", "no_comorbid_3levels", "crf3a_bmi_2levels", "crf1a_resp_support_4levels", "crf1a_treat_ss", "crf1a_treat_at", "crf1a_treat_tdac", "discharge_to_3m_review")
explanatory_multi = c("age_admission", "crf1a_sex", "crf1b_eth_5levels", "imd_quintile", "no_comorbid_3levels")

fit_cc = phosp_hosp %>% 
  finalfit(dependent, explanatory, keep_fit_id = TRUE)

fit_multi_imputed_pool = phosp_hosp_imputed %>% 
  mice::complete("all") %>%
  # Probably temp. Add age_admission_factor to imputed datasets
  purrr::map(~ mutate(., 
                      age_admission_factor = case_when(
                        age_admission < 30 ~ "<30",
                        age_admission < 40 ~ "30-39",
                        age_admission < 50 ~ "40-49",
                        age_admission < 60 ~ "50-59",
                        age_admission < 70 ~ "60-69",
                        age_admission < 80 ~ "70-79",
                        is.na(age_admission) ~ NA_character_,
                        TRUE ~ "80+"
                      ) %>% 
                        fct_relevel("50-59"),
                      
                      crf3a_bmi_2levels = case_when(
                        crf3a_bmi < 30 ~ "BMI < 30 kg/m^2",
                        is.na(crf3a_bmi) ~ NA_character_,
                        TRUE ~ "BMI 30+ kg/m^2"
                      ) %>% 
                        factor() %>% 
                        fct_relevel("BMI < 30 kg/m^2", "BMI 30+ kg/m^2") %>% 
                        ff_label("BMI (2 levels)")
  )
  ) %>% 
  purrr::map(~ glmmulti(.x, dependent, explanatory)) %>%
  as.mira() %>% 
  pool()


# Multilevel
library(broom.mixed)
fit_mixed_imputed_pool = phosp_hosp_imputed %>% 
  mice::complete("all") %>%
  # Probably temp. Add age_admission_factor to imputed datasets
  purrr::map(~ mutate(., 
               age_admission_factor = case_when(
                 age_admission < 30 ~ "<30",
                 age_admission < 40 ~ "30-39",
                 age_admission < 50 ~ "40-49",
                 age_admission < 60 ~ "50-59",
                 age_admission < 70 ~ "60-69",
                 age_admission < 80 ~ "70-79",
                 is.na(age_admission) ~ NA_character_,
                 TRUE ~ "80+"
               ) %>% 
                 fct_relevel("50-59"),
               
               crf3a_bmi_2levels = case_when(
                 crf3a_bmi < 30 ~ "BMI < 30 kg/m^2",
                 is.na(crf3a_bmi) ~ NA_character_,
                 TRUE ~ "BMI 30+ kg/m^2"
               ) %>% 
                 factor() %>% 
                 fct_relevel("BMI < 30 kg/m^2", "BMI 30+ kg/m^2") %>% 
                 ff_label("BMI (2 levels)"))
  ) %>% 
  purrr::map(~ glmmixed(.x, dependent, explanatory, random_effect = "redcap_data_access_group")) %>%
  as.mira() %>% 
  pool()

fit_multi_imputed = fit_multi_imputed_pool%>% 
  fit2df(estimate_name = "OR (multivariable imputation)", exp = TRUE)

fit_mixed_imputed = fit_mixed_imputed_pool%>% 
  fit2df(estimate_name = "OR (multilevel imputation)", exp = TRUE)
  
fit_cc %>% 
  # ff_merge(fit_uni_imputed) %>% 
  ff_merge(fit_multi_imputed) %>% 
  ff_merge(fit_mixed_imputed, last_merge = TRUE) %>% 
  # dplyr::relocate(1, 2, 3, 4, 5, 7, 6, 8) %>% 
  mytable()
```


## Figure: Multivariable logistic regression (multiple imputation) (with BMI 2 level) 

```{r fig.height=7, fig.width=12}
dependent = "psq_recovered"
explanatory = c("age_admission_factor", "crf1a_sex", "crf1b_eth_5levels", "imd_quintile", "no_comorbid_3levels", "crf3a_bmi_2levels", "crf1a_resp_support_4levels", "crf1a_treat_ss", "crf1a_treat_at", "crf1a_treat_tdac", "discharge_to_3m_review")

fit = phosp_hosp %>%
  or_plot(dependent, explanatory, column_space = c(-0.5, 0.15, 0.5), table_text_size = 4, 
          glmfit = fit_mixed_imputed_pool,
          dependent_label = "", suffix = "",
          breaks = c(0.2, 0.5, 1, 2, 5, 10, 30), )
# PDF 10 x 9
```

## New figure: Multivariable logistic regression (multiple imputation) (with BMI 2 level) 

```{r fig.height=7, fig.width=12}
dependent = "psq_recovered"
explanatory = c("age_admission_factor", "crf1a_sex", "crf1b_eth_5levels", "imd_quintile", "no_comorbid_3levels", "crf3a_bmi_2levels", "crf1a_resp_support_4levels", "crf1a_treat_ss", "discharge_to_3m_review")

fit = phosp_hosp %>%
  or_plot(dependent, explanatory, column_space = c(-0.5, 0.15, 0.5), table_text_size = 4, 
          glmfit = fit_mixed_imputed_pool,
          dependent_label = "", suffix = "",
          breaks = c(0.2, 0.5, 1, 2, 5, 10, 30), )
# PDF 10 x 9
```


## Add in figure of distributions of recovery
```{r fig.height=6, fig.width=8}
phosp_hosp %>% 
  filter(discharge_to_3m_review > 0) %>%  # Date error
  filter(discharge_to_3m_review <= 240) %>%  # Date error
  ggplot_lancet() +
  geom_histogram(aes(discharge_to_3m_review), binwidth = 7) +
  xlab("Discharge to review time (days)") +
  ggtitle("Time from hospital discharge to clinic review")
```

## Counts for models

```{r}
## Decide about metrcs later
dependent = "psq_recovered"
explanatory = c("age_admission_factor", "crf1a_sex", "crf1b_eth_5levels", "imd_quintile", "no_comorbid_3levels", "crf3a_bmi_2levels", "crf1a_resp_support_4levels", "crf1a_treat_ss", "crf1a_treat_at", "crf1a_treat_tdac")


## Complete case no discharge2review
phosp_hosp %>% 
  select(dependent, explanatory) %>% 
  drop_na() %>% 
  dim()
  
# 621

# Imputed no discharge2review
phosp_hosp_imputed %>% 
  mice::complete(1) %>% 
  mutate(age_admission_factor = case_when(
    age_admission < 30 ~ "<30",
    age_admission < 40 ~ "30-39",
    age_admission < 50 ~ "40-49",
    age_admission < 60 ~ "50-59",
    age_admission < 70 ~ "60-69",
    age_admission < 80 ~ "70-79",
    is.na(age_admission) ~ NA_character_,
    TRUE ~ "80+"
  ) %>% 
    fct_relevel("50-59"),
  
  crf3a_bmi_2levels = case_when(
    crf3a_bmi < 30 ~ "BMI < 30 kg/m^2",
    is.na(crf3a_bmi) ~ NA_character_,
    TRUE ~ "BMI 30+ kg/m^2"
  ) %>% 
    factor() %>% 
    fct_relevel("BMI < 30 kg/m^2", "BMI 30+ kg/m^2") %>% 
    ff_label("BMI (2 levels)")) %>% 
  select(dependent, explanatory) %>% 
  drop_na() %>% 
  dim()

# 1077

explanatory = c("age_admission_factor", "crf1a_sex", "crf1b_eth_5levels", "imd_quintile", "no_comorbid_3levels", "crf3a_bmi_2levels", "crf1a_resp_support_4levels", "crf1a_treat_ss", "crf1a_treat_at", "crf1a_treat_tdac", "discharge_to_3m_review")

# Imputed no discharge2review
phosp_hosp_imputed %>% 
  mice::complete(1) %>% 
  mutate(age_admission_factor = case_when(
    age_admission < 30 ~ "<30",
    age_admission < 40 ~ "30-39",
    age_admission < 50 ~ "40-49",
    age_admission < 60 ~ "50-59",
    age_admission < 70 ~ "60-69",
    age_admission < 80 ~ "70-79",
    is.na(age_admission) ~ NA_character_,
    TRUE ~ "80+"
  ) %>% 
    fct_relevel("50-59"),
  
  crf3a_bmi_2levels = case_when(
    crf3a_bmi < 30 ~ "BMI < 30 kg/m^2",
    is.na(crf3a_bmi) ~ NA_character_,
    TRUE ~ "BMI 30+ kg/m^2"
  ) %>% 
    factor() %>% 
    fct_relevel("BMI < 30 kg/m^2", "BMI 30+ kg/m^2") %>% 
    ff_label("BMI (2 levels)"))  %>% 
  select(dependent, explanatory) %>% 
  drop_na() %>% 
  dim()

# 1077
```

## Add in - EQ5D population norm vs reported. 


```{r fig.height=6, fig.width=8}
phosp_3m %>% 
  left_join(phosp_hosp %>% select(study_id, eq5d_population_norm)) %>% 
  select(eq5d_population_norm, eq5d5l_summary_pre) %>% 
  mutate(eq5d_population_norm = eq5d_population_norm * 100) %>% 
  rename(
    "EQ5D VAS population norm" = eq5d_population_norm,
    "EQ5D VAS pre-COVID reported" =  eq5d5l_summary_pre
  ) %>% # ff_glimpse()
  gather() %>% 
  ggplot_lancet(aes(x = value, fill = key)) + 
  labs(fill = "", x = "EQ5D VAS") +
  geom_density(bw = 5, alpha = 0.8) + 
  theme(
    legend.position = c(0.05, 1),
    legend.justification = c(0, 1)
  )
```



```{r fig.height=12, fig.width=8}
library(egg)
library(grid)

p1 = phosp_3m %>% 
  select(matches("eq5d5l_q.*_delta_change$")) %>% 
  gather() %>% 
  group_by(key, value) %>% 
  summarise(n = n()) %>% 
  drop_na() %>% 
  group_by(key) %>% 
  mutate(
    nn = sum(n),
    prop = 100 * n / nn,
    prop = ifelse(value %in% c("No change", "Improvement"), prop * -1, prop)) %>% 
  ungroup() %>% 
  mutate(key = fct_recode(key, 
                          "Mobility" = "eq5d5l_q1_delta_change",
                          "Self-care" = "eq5d5l_q2_delta_change",
                          "Usual activities" = "eq5d5l_q3_delta_change",
                          "Pain / discomfort" = "eq5d5l_q4_delta_change",
                          "Anxiety / Depression " = "eq5d5l_q5_delta_change")
  ) %T>%
  {label_data <<- (.) %>% 
    filter(value == "Worse") %>% 
    mutate(prop_label = paste0(round_tidy(prop, 1), "%"))} %>%
  ggplot_lancet(aes(x = fct_rev(key), y = prop, fill = value)) + 
  geom_col() +
  geom_text(data = label_data, aes(label = prop_label), size = 5, colour = "white", hjust = 1.3) +
  coord_flip() + 
  scale_fill_brewer("", palette = "Blues") +
  labs(y = "Proportion (%)", x = "") +
  theme(legend.position = c(1, 1.35),
        legend.background=element_blank()) +
  ggtitle("Change in EQ5D domains (whole cohort)",
          " ")


p2 = phosp_3m %>% 
  select(crf1a_resp_support_4levels, matches("eq5d5l_q.*_delta_change$")) %>% 
  gather("key", "value", -crf1a_resp_support_4levels) %>% 
  group_by(key, value, crf1a_resp_support_4levels) %>% 
  summarise(n = n()) %>% 
  drop_na() %>% 
  group_by(key, crf1a_resp_support_4levels) %>% 
  mutate(
    nn = sum(n),
    prop = 100 * n / nn,
    prop = ifelse(value %in% c("No change", "Improvement"), prop * -1, prop)
  ) %>% 
  ungroup() %>% 
  mutate(
    key = fct_recode(key, 
                     "Mobility" = "eq5d5l_q1_delta_change",
                     "Self-care" = "eq5d5l_q2_delta_change",
                     "Usual activities" = "eq5d5l_q3_delta_change",
                     "Pain / discomfort" = "eq5d5l_q4_delta_change",
                     "Anxiety / Depression " = "eq5d5l_q5_delta_change")
  ) %T>%
  {label_data <<- (.) %>% 
    filter(value == "Worse") %>% 
    mutate(prop_label = paste0(round_tidy(prop, 1), "%"))} %>%
  ggplot_lancet(aes(x = fct_rev(key), y = prop, fill = value)) + 
  geom_col() +
  geom_text(data = label_data, aes(label = prop_label), size = 4, colour = "white", hjust = 1.1) +
  coord_flip() + 
  scale_fill_brewer("", palette = "Blues") +
  labs(y = "Proportion (%)", x = "") +
  facet_wrap(. ~ crf1a_resp_support_4levels) +
  theme(legend.position = c(1, 1.25),
        legend.background = element_blank()) +
  ggtitle("Change in EQ5D domain (stratified)",
          " ")

p3 = phosp_3m %>% 
  select(eq5d5l_summary_delta, eq5d5l_utility_index_delta) %>% 
  gather() %>% 
  mutate(key = 
           fct_recode(key, 
                      "Change in VAS" = "eq5d5l_summary_delta",
                      "Change in utility index" = "eq5d5l_utility_index_delta"
           )
  ) %>% 
  ggplot_lancet(aes(x = "", y = value)) + 
  geom_boxplot(aes(fill = key), width.errorbar = 0) + 
  # geom_jitter(width = 0.4, alpha = 0.05) +
  geom_hline(yintercept = 0) +
  scale_y_continuous(expand = c(0.1, 0)) +
  coord_flip() +
  labs(x = "", y = "") +
  facet_grid(. ~ key, scale = "free_x") + 
  theme(legend.position = "none",
        axis.ticks.y = element_blank()) + 
  ggtitle("Change in EQ5D summary metrics (whole cohort)")


p4 = phosp_3m %>% 
  select(eq5d5l_summary_delta, eq5d5l_utility_index_delta, crf1a_resp_support_4levels) %>% 
  gather("key", "value", -crf1a_resp_support_4levels) %>% 
  mutate(key = 
           fct_recode(key, 
                      "Change in VAS" = "eq5d5l_summary_delta",
                      "Change in utility index" = "eq5d5l_utility_index_delta"
           )
  ) %>% 
  ggplot_lancet(aes(x = fct_rev(crf1a_resp_support_4levels), y = value)) + 
  geom_boxplot(aes(fill = key), width.errorbar = 0) + 
  # geom_jitter(width = 0.2, alpha = 0.2) +
  geom_hline(yintercept = 0) +
  scale_y_continuous(expand = c(0.1, 0)) +
  coord_flip() +
  labs(x = "", y = "") +
  facet_grid(. ~ key, scale = "free_x") + 
  theme(legend.position = "none") + 
  ggtitle("Change in EQ5D summary metrics (stratified)")


ggarrange(p1, p3, p2, p4, ncol = 1, labels = c("A", "B", "C", "D"), heights = c(1, 1, 2, 1),
               label.args = list(gp=gpar(font=1, cex = 1.5))
               )

# PDF 8,65 x 12
```
