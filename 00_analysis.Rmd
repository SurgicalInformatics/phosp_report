---
title: "PHOSP-COVID report"
author: "PHOSP-COVID collaborative"
date: "10/02/2021"
output:
  html_document:
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      warning = FALSE,
                      message = FALSE)
library(finalfit)
library(knitr)
library(tidyverse)
# library(downloadthis)
library(rmarkdown)
```

```{r}
# Pull and prep
source("01_data_pull.R")
lastrun = Sys.time()
source("02_functions.R")
source("03_prep.R")
```

```{r eval=FALSE, include=FALSE}
# Render PDF
if (knitr::is_html_output()){
options(knitr.duplicate.label = "allow")
rmarkdown::render('00_analysis.Rmd', output_format = 'pdf_document', output_file = 'phosp_report.pdf', 
                  envir = new.env(), clean = T)
}
```

```{r eval=FALSE, include=FALSE}
if (knitr::is_html_output()){
  download_file(
  path = 'phosp_report.pdf',
  output_name = "PHOSP-COVID report",
  button_label = "Download PDF",
  button_type = "danger",
  has_icon = TRUE,
  icon = "fa fa-save",
  self_contained = FALSE
)
}
```

```{r eval=FALSE, include=FALSE}
# For exploration 
phosp_hosp = readRDS("phosp_hosp.rds")
phosp_3m = readRDS("phosp_3m.rds")
lastrun = Sys.time()
source("02_functions.R")
```

Dynamic content updated: `r lastrun`. 

```{r}
# Define variable sets
## These will likely changed and be moved to analysis chunks
explanatory = c("age_admission", "crf1a_sex", 
                "crf1b_eth_5levels", 
                
                "crf1b_income", 
                "crf1b_edu",
                "crf1a_pregnant_yn",
                "crf1a_post_partum_yn",
                
                # Comorbidities
                'no_comorbid',
                'crf1a_com_card_mi', 'crf1a_com_card_ihd', 
                'crf1a_com_card_af', 'crf1a_com_card_ht', 
                'crf1a_com_card_chf', 'crf1a_com_card_chd', 
                'crf1a_com_card_vhd', 'crf1a_com_card_pid', 
                'crf1a_com_card_pvd', 'crf1a_com_card_hcd', 
                'crf1a_com_card_catia', 
                #'crf1a_com_card_other_yn', 'crf1a_com_card_other', 
                #''crf1a_com_neupsy_dem', 
                #'crf1a_com_neupsy_other_yn', 
                'crf1a_com_neupsy_da', 
                'crf1a_com_neupsy_chron', 'crf1a_com_neupsy_pam', 
                'crf1a_com_neupsy_ptm', 
                #'crf1a_com_neupsy_other', 
                'crf1a_com_res_copd', 'crf1a_com_res_ast', 
                'crf1a_com_res_ild_yn', 'crf1a_com_res_bron', 
                'crf1a_com_res_osa', 'crf1a_com_res_ohs', 
                'crf1a_com_res_pe', #'crf1a_com_res_other_yn', 
                #'crf1a_com_res_ild', 'crf1a_com_res_other', 
                'crf1a_com_rheu_ctd', 'crf1a_com_rheu_ra', 
                'crf1a_com_rheu_ost', 
                #'crf1a_com_rheu_other_yn', 'crf1a_com_rheu_other', 
                'crf1a_com_gast_pud', 
                'crf1a_com_gast_ld', 'crf1a_com_gast_gord', 
                'crf1a_com_gast_ibd', 'crf1a_com_gast_ibs', 
                #'crf1a_com_gast_other_yn', 'crf1a_com_gast_other', 
                'crf1a_com_mer_diab', 'crf1a_com_mer_diab_com', 
                'crf1a_com_mer_hypot', 'crf1a_com_mer_hypert', 
                'crf1a_com_mer_ckd_yn', 
                #'crf1a_com_mer_other_yn', 
                'crf1a_com_mer_ckd_stage', 
                #'crf1a_com_mer_other', 
                'crf1a_com_mh_stm', #'crf1a_com_mh_stm_detail', 
                'crf1a_com_mh_leuk_yn', 'crf1a_com_mh_lymp_yn', 
                #'crf1a_com_mh_other_yn', 
                #''crf1a_com_mh_leuk_detail', 
                #'crf1a_com_mh_lymp', 
                #'crf1a_com_mh_other', 
                'crf1a_com_id_aids', 'crf1a_com_id_hiv', 
                'crf1a_com_id_cvh', 'crf1a_com_id_mt',
                #'crf1a_com_id_other_yn'
                
                # Symptoms
                'crf1a_fever_history', 'crf1a_cough', 'crf1a_cough_sputum', 'crf1a_cough_blood', 
                'crf1a_sore_throat', 'crf1a_runny_nose', 'crf1a_ear_pain', 'crf1a_wheezing', 
                'crf1a_chest_pain', 'crf1a_muscle_aches', 'crf1a_join_pain', 'crf1a_fatigue', 
                'crf1a_shortness_breath', 'crf1a_loss_taste', 'crf1a_loss_smell', 'crf1a_chest_indrawing', 
                'crf1a_headache', 'crf1a_confusion', 'crf1a_seizures', 'crf1a_pain', 'crf1a_nausea', 
                'crf1a_diarrhoea', 'crf1a_conjunctivitis', 'crf1a_skin_rash', 'crf1a_skin_ulcers', 
                'crf1a_lymphadenopathy', 'crf1a_bleeding'
                )

explanatory_symptoms = c("psq_scale_blness_pre", "psq_scale_fatigue_pre", "psq_scale_cough_pre", 
                "psq_scale_pain_pre", "psq_scale_sleep_pre", 
                
                "mrcds_blness_exer_pre", "mrcds_short_level_pre",
                "mrcds_walk_slower_pre", "mrcds_after_walk_pre", "mrcds_leave_house_pre"
)  

explanatory_duration = c("crf1a_symptom_duration", 
                "crf1a_admission_duration")

explanatory_complications = c("crf1a_add_diag_pemt", "crf1a_add_diag_myoc",
                              "crf1a_add_diag_cmp", "crf1a_add_diag"
)

explanatory_treatment = c("crf1a_treat_ss", "crf1a_treat_at", "crf1a_treat_tdac")

explanatory_trials = c("crf1a_studies___2", "crf1a_studies___3", "crf1a_studies___4", 
                          "crf1a_studies___5", "crf1a_studies___6", "crf1a_studies___7", 
                          "crf1a_studies___8", "crf1a_studies___9", "crf1a_studies___10", 
                          "crf1a_studies___11", "crf1a_studies___12", "crf1a_studies___13", 
                          "crf1a_studies___14", "crf1a_studies___15", "crf1a_studies___16", 
                          "crf1a_studies___17", "crf1a_studies___18", "crf1a_studies___19",
                          "crf1a_studies___20", "crf1a_studies___21")

```

## Patients by tiers

```{r}
phosp_hosp %>% 
  count(tier) %>% 
  mytable()
```

All analyses below are for tier 2 patients only. 

```{r}
phosp_hosp = phosp_hosp %>% 
  filter(tier == 2)
```

## Data completeness

### Demographics

```{r}
dependent = "crf1a_resp_support_4levels"
phosp_hosp %>% 
  select(dependent, explanatory) %>% 
  missing_glimpse() %>% 
  mytable()
```

### Symptoms

```{r}
phosp_3m %>% 
  select(explanatory_symptoms) %>% 
  missing_glimpse() %>% 
  mytable()
```

### Dates

```{r}
phosp_hosp %>% 
  select(
    crf1a_date_first_symptoms, crf1a_date_adm, crf1a_date_dis,
    explanatory_duration) %>% 
  missing_glimpse() %>% 
  mytable()
```

### Complications

```{r}
phosp_hosp %>% 
  select(explanatory_complications) %>% 
  missing_glimpse() %>% 
  mytable()
```

### Treatment

```{r}
phosp_hosp %>% 
  select(explanatory_treatment) %>% 
  missing_glimpse() %>% 
  mytable()
```


## Missing data maps (light blue missing)

```{r fig.height=12, fig.width=8}
phosp_hosp %>% 
  select(explanatory, 
                 explanatory_duration, 
                 explanatory_complications,
                 explanatory_treatment) %>% 
  remove_labels() %>% 
  missing_plot()
```


```{r fig.height=2, fig.width=8}
phosp_3m %>% 
    select(explanatory_symptoms) %>% 
  remove_labels() %>% 
  missing_plot()
```

## Distribution examples

### Admission and symptom 

Including out-of-range values

```{r}
phosp_hosp %>% 
  select(explanatory_duration) %>% 
  pivot_longer(explanatory_duration) %>% 
  ggplot_lancet(aes(value, fill = name)) +
  geom_density() + 
  facet_wrap(~ name) + 
  labs(x = "Days") + 
  theme(legend.position = "none")
```

Filtered >=0, <=100 days

```{r}
phosp_hosp %>% 
  select(explanatory_duration) %>% 
  pivot_longer(explanatory_duration) %>% 
  filter(value >= 0) %>% 
  filter(value <= 100) %>% 
  ggplot_lancet(aes(value, fill = name)) +
  geom_density() + 
  facet_wrap(~ name) + 
  labs(x = "Days") + 
  theme(legend.position = "none")
```

### Discharge date

```{r}
phosp_hosp %>% 
  ggplot_lancet(aes(crf1a_date_dis)) +
  geom_histogram(fill = "lightblue", bins = 200) +
  labs(x = "Discharge date") + 
  ggtitle("Discharge date histogram")
```


## Tables

### Table 1A. Patient characteristics stratifed by maximal level of organ support.

Stratified by maximal level of support. 

```{r}
dependent = "crf1a_resp_support_4levels"
phosp_hosp %>% 
  summary_factorlist(dependent,  explanatory, 
                     na_include = TRUE, na_include_dependent = TRUE,
                     add_col_totals = TRUE, add_row_totals = TRUE,
                     total_col = TRUE) %>% 
  mytable()
```

### Table 1B. Pre-existing symptoms stratifed by maximal level of organ support.

```{r}
phosp_3m %>% 
  left_join(phosp_hosp %>% select(study_id, crf1a_resp_support_4levels)) %>% 
  summary_factorlist(dependent,  explanatory_symptoms, 
                     na_include = TRUE, na_include_dependent = TRUE,
                     add_col_totals = TRUE, add_row_totals = TRUE,
                     total_col = TRUE) %>% 
  mytable()
```


### Table 1C. Symptom and admission duration stratifed by maximal level of organ support.

```{r}
phosp_hosp %>% 
  summary_factorlist(dependent,  explanatory_duration, 
                     na_include = TRUE, na_include_dependent = TRUE,
                     add_col_totals = TRUE, add_row_totals = TRUE,
                     total_col = TRUE) %>% 
  mytable()
```

### Table 1D. Symptom and admission duration stratifed by maximal level of organ support.

```{r}
phosp_hosp %>% 
  summary_factorlist(dependent,  explanatory_complications, 
                     na_include = TRUE, na_include_dependent = TRUE,
                     add_col_totals = TRUE, add_row_totals = TRUE,
                     total_col = TRUE) %>% 
  mytable()
```

### Table 1E. Treatments stratifed by maximal level of organ support.

```{r}
phosp_hosp %>% 
  summary_factorlist(dependent,  explanatory_treatment, 
                     na_include = TRUE, na_include_dependent = TRUE,
                     add_col_totals = TRUE, add_row_totals = TRUE,
                     total_col = TRUE) %>% 
  mytable()
```

### Table 1F. Trial involvement stratifed by maximal level of organ support.

```{r}
phosp_hosp %>% 
  summary_factorlist(dependent,  explanatory_trials, 
                     na_include = TRUE, na_include_dependent = TRUE,
                     total_col = TRUE) %>% 
  ff_remove_ref() %>% 
  select(-levels) %>% 
  mytable()
```


# Appendix

Stratified by maximal level of support. 

```{r}
dependent = "crf1a_resp_support_8levels"
phosp_hosp %>% 
  summary_factorlist(dependent,  explanatory, 
                     na_include = TRUE, na_include_dependent = TRUE,
                     add_col_totals = TRUE, add_row_totals = TRUE,
                     total_col = TRUE) %>% 
  mytable()
```

